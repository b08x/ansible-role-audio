- name: configure udev
  become: yes
  template:
    src: udev_rules.j2
    dest: /etc/udev/rules.d/39-audio.rules
  notify: "reload udev rules"
- name: install packages
  become: yes
  apt: 
    name:
    - avahi-daemon
    - pulseaudio-module-zeroconf
    # - pulse-audio-x11
    - shairport-sync
    - pulsemixer
    state: present
- name: asound conf
  become: yes
  template:
    src: asound_conf.j2
    dest: /etc/asound.conf
  notify:
    - "reload alsa"
- name: write pulseaudio daemon.conf
  become: yes
  template:
    src: pulseaudio_daemon_conf.j2
    dest: /etc/pulse/daemon.conf
  notify: "restart pulseaudio"
- name: write pulseaudio client conf
  become: yes
  template:
    src: pulseaudio_client.conf.j2
    dest: /etc/pulse/client.conf
  notify: "restart shairport"
- name: write pulseaudio default.pa
  become: yes
  template:
    src: pulse_default.pa.j2
    dest: /etc/pulse/default.pa
  notify: "restart pulseaudio"
- name: disable single shairport
  become: yes
  systemd:
    name: "shairport-sync"
    state: stopped
    enabled: no
- name: configure shairport-sync
  become: yes
  template:
    src: shairport_default.j2
    dest: "/etc/default/shairport-sync"
  notify: "restart shairport"
- name: allow shairport to talk to pulse
  become: yes
  user:
    name: "shairport-sync"
    groups:
      - "pulse-access"
      - "audio"
- name: make shairport systemd worker
  become: yes
  copy:
    src: "shairport-sync@.service"
    dest: "/lib/systemd/system/shairport-sync@.service"
  notify: "reload systemd"
- name: make shairport target item
  become: yes
  template:
    src: "shairport-sync.target.j2"
    dest: "/etc/systemd/system/shairport-sync.target"
  notify: "reload systemd"
- meta: flush_handlers
- name: enable multi shairport
  become: yes
  systemd:
    name: "shairport-sync.target"
    enabled: yes
    state: started
    

# Allegedly, using pulseaudio as a global server is bad:
# https://www.freedesktop.org/wiki/Software/PulseAudio/Documentation/User/WhatIsWrongWithSystemWide/
#
# but it can be done:
#
# https://askubuntu.com/questions/939144/playing-audio-stops-in-unity-when-i-switch-user/939338#939338
# https://askubuntu.com/questions/28176/how-do-i-run-pulseaudio-in-a-headless-server-installation
#
# However it may be better to specify that the default-logged-in user
# uses pulseaudio?

